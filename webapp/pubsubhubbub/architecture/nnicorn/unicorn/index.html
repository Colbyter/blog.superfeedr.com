<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="ofroHQ3qXBS1SQfblK9-U_oduGZ975Bb3i_uP13Myao" />

  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,400italic|Source+Code+Pro:400,600' rel='stylesheet' type='text/css'>

  <link href="/css/front.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/css/prism.css" rel="stylesheet" type="text/css">

  <title>Superfeedr : Unicorn </title>

  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">
  <link rel="webmention" href="https://webmention.herokuapp.com/api/webmention" />

  <meta http-equiv="Content-Security-Policy" content="connect-src stream.superfeedr.com">

  <link rel="shortcut icon" href="/favicon.png">

</head>
<body>
  <header class="header">
    <div class="container">
      <h1 class="header-logo"><a href="/"><img src="/images/logo.png" alt=""> <span>Superfeedr Blog</span></a></h1>
      <nav class="nav-header">
        <ul class="nav-items">
          <li class="nav-item"><a href="http://superfeedr.com/about" class="nav-link">About</a></li>
          <li class="nav-item"><a href="http://superfeedr.com/publisher" class="nav-link">Publishers</a></li>
          <li class="nav-item"><a href="http://superfeedr.com/subscriber" class="nav-link">Subscribers</a></li>
          <li class="nav-item"><a href="http://superfeedr.com/subscriber/pricing" class="nav-link">Pricing</a></li>
          <li class="nav-item"><a href="http://superfeedr.com/login" class="nav-link nav-link-bubble">Login</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container body">
    <header class="body-header">
      <div class="blog-links">
        <input type="button" class="button  button--raised  button--positive" value="Subscribe" onclick="(function(){var z=document.createElement('script');z.src='http://www.subtome.com/load.js';document.body.appendChild(z);})()">
        <a href="/archive.html" class="button  button--raised  button--neutral">Read Archives</a>
      </div>
      <h2><strong>Blog</strong></h2>
    </header>

    <div class="body-content">
      <section class="column  column--terms  body-content-text">
        <article class="blog-article blog-article--single h-entry">
  <h3 class="entry-title p-name"><a class="u-url" href="/webapp/pubsubhubbub/architecture/nnicorn/unicorn">Unicorn</a></h3>

  <span class="invisible u-uid" style="display:none">blog.superfeedr.com:/webapp/pubsubhubbub/architecture/nnicorn/unicorn</span>

  <div class="entry-meta">
    <ul class="entry-meta--primary postmeta">
      <li class="entry-meta--item">By <span class="p-author h-card"><img class="u-photo" src="http://www.gravatar.com/avatar/b30ce50678f0e934eaa6697425c59dd7?s=20" > <a href="http://ouvre-boite.com" rel="author">Julien</a></span></li>
      <li class="entry-meta--item dt-published" datetime="2010-03-29T00:00:00+02:00"><time>29 Mar 2010</time></li>
    </ul>
  </div>
  <div class="entry-content e-content">
    <p><img src="http://github.com/images/error/angry_unicorn.png" style="float:left; padding:10px;" alt="" /></p>
<p>In the past few weeks, our web server have really been pushed to limits that we weren&#8217;t expecting to reach so quickly. We&#8217;re now receiving between <strong>150 and 300 requests</strong> per second. Some of them are <a href="http://documentation.superfeedr.com/subscribers.html#webhooks">PubSubHubbub subscriptions</a>, but the bulk of it is pings that we receive for the various hubs that we host.</p>
<p>This brought a whole lot of issues in the past weeks. Issues that we decided to address by <strong>splitting the web server and the app server</strong>. Up until now, we were using <a href="http://www.modrails.com/">Passenger</a> and <a href="http://nginx.org/">Nginx</a>. We now use the new cool kid in the field: <a href="http://unicorn.bogomips.org/">Unicorn</a> to serve the app.</p>
<p>The migration was easy : we set up a new server from the ground, and, since we host our <span class="caps">DNS</span> server, we just changed the <span class="caps">DNS</span> to the IP of this new server. The old one is still &#8220;on&#8221; for a week, after which we will turn it off.</p>
<h3>Recipe</h3>
<p>A 2GB server, with Ubuntu. A base of <a href="http://www.rubyenterpriseedition.com/">Ruby Enterprise Edition</a>, as for most of our Ruby programs. Nginx as the web server, and, Unicorn to serve the Rails app.</p>
<p>Settings were quite easy too. We mostly copied what was available in the <a href="http://unicorn.bogomips.org/Unicorn/Configurator.html">Unicorn doc</a>. Here is for the NginX :<br />
<script src="http://gist.github.com/347898.js?file=gistfile1.txt"></script><br />
Note that we have similar settings for <code>https</code> (port 443).</p>
<p>We then added the <code>unicorn.rb</code> file to our git repo for the web app. Again, we <a href="http://unicorn.bogomips.org/examples/unicorn.conf.rb">copied them from the doc</a>. Here it is:<br />
<script src="http://gist.github.com/347907.js?file=gistfile1.rb"></script></p>
<p>As you can see, we disconnect the master unicorn process from MySQL and Mongo before forking, and we connect them (as well as Redis and the Queue) after forking, so they can be used directly by the worker processes.</p>
<p>Finally, we added a small <code>init.d</code> script to allow easier control of the unicorn processes :<br />
<script src="http://gist.github.com/347910.js?file=gistfile1.sh"></script></p>
<p>On a site note, I rewrote the <a href="http://rubygems.org/gems/bosh">Bosh gem</a>. <a href="http://xmpp.org/extensions/xep-0124.html">Bosh</a> is the magic which allows to communicate with an <span class="caps">XMPP</span> server via <span class="caps">HTTP</span>. This gem allows to pre-bind the <span class="caps">XMPP</span> connection (and obfuscate the credentials) for faster handling in the browser, with <a href="http://code.stanziq.com/strophe/">StropheJs</a>, for example. The existing <a href="http://github.com/skyfallsin/ruby_bosh">RubyBOSH</a> worked fine but used <a href="http://hpricot.com/">Hpricot</a> and &#8220;RestClient&#8221;;http://rdoc.info/projects/archiloque/rest-client, while our web app already had dependencies for <a href="http://nokogiri.org/">Nokogiri</a> and <a href="http://github.com/pauldix/typhoeus">Typhoeus</a>. It&#8217;s always good to <em>reduce the memory footprint by removing un-neeede dependencies</em>.</p>
<p>We have a few more things to fine tune, for our server seems to be much more at ease now :) A small <a href="http://httpd.apache.org/docs/2.0/programs/ab.html">ab</a> benchmark shows us that the new settings as an average response time 20% shorter than with Nginx+Passenger. At the same time, the load on the web server was divided by 2.</p>
<p>One of the great benefits of that, is that we can already prepare the moment where we&#8217;ll use 2 (or more) instances of unicorn running on different hosts, with Nginx in front of them all. if you want to read more about Unicorn, the <a href="http://github.com/blog/517-unicorn">Github article</a> by <a href="http://github.com/defunkt">@defunkt</a> is probably one of the most complete :)</p>
<p>Ah, and yes, we got rid of the stripes. Unicorns don&#8217;t have stripes.</p>
  </div>
</article>
<div class="blog-more">
  Liked this post? <a href="/archive.html">Read the archive</a> or <input type="button" value="Subscribe" class="button  button--raised  button--positive" onclick="(function(){var z=document.createElement('script');z.src='http://www.subtome.com/load.js';document.body.appendChild(z);})()">
</div>
<div class="blog-comments">
  <h3>Comments</h3>

    <div id="disqus_thread">
    </div>

    <script type="text/javascript" src="https://disqus.com/forums/superfeedr-thoughts/embed.js"></script>
    <noscript>
        <a href="https://superfeedr-thoughts.disqus.com/?url=ref">View the discussion thread.</a>
    </noscript>

    <script id="webmention-hosted">
    (function () {
      var sn = document.createElement("script"), s = document.getElementsByTagName("script")[0], url;
      url = document.querySelectorAll ? document.querySelectorAll("link[rel~=canonical]") : false;
      url = url && url[0] ? url[0].href : false;
      sn.type = "text/javascript"; sn.async = true;
      sn.src = "//webmention.herokuapp.com/api/embed?url=" + encodeURIComponent(url || window.location);
      s.parentNode.insertBefore(sn, s);
    }());
    </script>
</div>

      </section>
    </div>

  </main>

  <div class="footer container">
    <footer class="site-footer">
      <ul class="site-footer__list">
<!--         <li class="site-footer__item"><a href="" class="site-footer__link">Documentation</a></li>
        <li class="site-footer__item"><a href="" class="site-footer__link">Support</a></li>
        <li class="site-footer__item"><a href="" class="site-footer__link">Blog</a></li>
        <li class="site-footer__item"><a href="/pricing.html" class="site-footer__link">Pricing</a></li>
        <li class="site-footer__item"><a href="" class="site-footer__link">Terms</a></li>
 -->      </ul>
      <ul class="site-footer__meta">
        <p class="site-footer__copyright">&copy; 2009&ndash;2014 Superfeedr</p>
      </ul>
    </footer>
  </div>



  


  <script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script>
  <script type="text/javascript">
  <!--//--><![CDATA[//><!--
  try {
    var pageTracker = _gat._getTracker('UA-9285763-1');
    pageTracker._setDomainName("superfeedr.com");
    pageTracker._initData();
    pageTracker._trackPageview();
  } catch(err) {}
  //--><!]]>
  </script>

  <script src="/scripts/prism.js"></script>

</body>
</html>



